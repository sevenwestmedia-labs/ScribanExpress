# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger:
- master

pr:
- master

pool:
  vmImage: 'Ubuntu-16.04'

variables:
  buildConfiguration: 'Release'

steps:
- script: dotnet build --configuration $(buildConfiguration)
  displayName: 'dotnet build $(buildConfiguration)'

- task: DotNetCoreCLI@2
  name: Test
  inputs:
    command: 'test'
#    arguments: ' /p:CollectCoverage=true  /p:CoverletOutputFormat=cobertura /p:Exclude="[xunit*]*%2c[Scriban]*%2c[*UnitTests*]*" '
    arguments: ' /p:CollectCoverage=true  /p:CoverletOutputFormat=cobertura /p:CoverletOutput=$(Build.SourcesDirectory)\TestResults\Coverage\  /p:Exclude="[xunit*]*%2c[Scriban]*%2c[*UnitTests*]*" '

    # Would prefer to put a wildcard for cobertura.xml but not sure it works on sub directorys
- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: 'Cobertura'
    #summaryFileLocation: '$(Build.SourcesDirectory)\**\coverage.cobertura.xml'
    summaryFileLocation: '$(Build.SourcesDirectory)/TestResults/Coverage/coverage.cobertura.xml'

- task: DotNetCoreCLI@2
  displayName: Pack
  inputs:
    command: 'pack'
    versioningScheme: 'byPrereleaseNumber'
    requestedMajorVersion: '0'
    requestedMinorVersion: '1'

- task: PublishPipelineArtifact@0
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)'

- task: BuildQualityChecks@5
  inputs:
    checkCoverage: true
    coverageType: branches
    coverageFailOption: 'fixed'
    coverageThreshold: '69'

- script: cd $(Build.SourcesDirectory) && ls

- task: NuKeeper@0
  inputs:
    arguments: '-m 3'